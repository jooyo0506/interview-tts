# 语音合成v2.0 - 详细设计文档

## 一、项目概述

基于豆包语音2.0 API（双向流式TTS）实现新一代语音合成功能，支持语音指令、引用上文、语音标签三大核心能力。

## 二、API技术方案

### 2.1 连接配置

| 参数 | 值 |
|------|-----|
| WebSocket URL | `wss://openspeech.bytedance.com/api/v3/tts/bidirection` |
| 鉴权Header | X-Api-App-Key, X-Api-Access-Key, X-Api-Resource-Id |
| Resource-ID | `seed-tts-2.0` (TTS2.0字符版) |

### 2.2 交互流程

```
客户端 → WebSocket → 服务端
  │
  ├─ CONNECT: 建立连接(携带鉴权头)
  │
  ├─ START_CONNECTION(event=1): 发起连接
  │
  ├─ START_SESSION(event=100): 开始会话(带session_id+参数)
  │
  ├─ TASK_REQUEST(event=200): 发送文本
  │    │
  │    ├─ TTS_SENTENCE_START(event=350): 句子开始
  │    ├─ TTS_RESPONSE(event=352): 音频数据(流式)
  │    └─ TTS_SENTENCE_END(event=351): 句子结束
  │
  ├─ FINISH_SESSION(event=102): 结束会话
  │
  └─ FINISH_CONNECTION(event=2): 关闭连接
```

### 2.3 核心参数

```java
// 请求参数
{
    "user": {"uid": "xxx"},
    "namespace": "BidirectionalTTS",
    "req_params": {
        "speaker": "zh_female_cancan_mars_bigtts",  // 音色ID
        "text": "合成文本",
        "audio_params": {
            "format": "mp3",
            "sample_rate": 24000,
            "enable_timestamp": true
        },
        "additions": {
            "context_texts": ["上文内容"],  // 引用上文
            "disable_markdown_filter": false
        }
    },
    "event": 100  // 事件类型
}
```

## 三、功能设计

### 3.1 语音指令

**触发方式**: 文本中以 `#` 开头

**指令类型**:

| 类型 | 示例 | 说明 |
|------|------|------|
| 情绪 | #开心 / #悲伤 / #生气 / #惊讶 | 整体情绪控制 |
| 语气 | #撒娇 / #暧昧 / #吵架 / #严肃 | 语气风格 |
| 方言 | #四川话 / #北京话 / #东北话 | 方言切换 |
| 语速 | #语速慢 / #语速快 | 语速调整 |
| 音调 | #音调高 / #音调低 | 音调控制 |

**实现方式**: 前端解析 `#` 指令，转换为 `emotion` 参数或直接透传

### 3.2 引用上文

**触发方式**: 单独输入框

**参数映射**:

```java
// 前端传入
上部文本: "你怎么评价北京这个城市？"

// API参数
"additions": {
    "context_texts": ["你怎么评价北京这个城市？"]
}
```

**效果**: 模型理解上文的语境和情绪，承接合成

### 3.3 语音标签

**触发方式**: 文本中以 `【】` 包裹

**标签类型**:

| 分类 | 示例 |
|------|------|
| 表情 | 【开心地笑】 / 【皱眉】 / 【泪流满面】 |
| 心理 | 【内心紧张】 / 【窃喜】 / 【忐忑不安】 |
| 肢体 | 【站起来说】 / 【挥拳】 / 【低声私语】 |
| 语气 | 【小声悄悄话】 / 【大声喊】 / 【结巴】 |

**实现方式**: 前端解析 `【】` 标签，转换为带时间戳的SSML格式或直接透传

## 四、界面设计

### 4.1 页面结构

```
┌─────────────────────────────────────────────┐
│  🎤 语音合成 v2.0                    [返回]  │
├─────────────────────────────────────────────┤
│                                             │
│  说话人：可爱女生  [▼切换] [+添加说话人]    │
│                                             │
│  ┌─────────────────────────────────────┐   │
│  │ 模式：默认 ▼                        │   │ ← 点击弹出模式选择
│  └─────────────────────────────────────┘   │
│                                             │
│  ┌─────────────────────────────────────┐   │
│  │ 【开心】今天的天气真好呀！           │   │
│  │                                      │   │ ← 输入框：支持#指令和【标签】
│  │ #用温柔的语气                       │   │
│  │ 那我们出去走走吧                    │   │
│  └─────────────────────────────────────┘   │
│  29 字符                                    │
│                                             │
│  ─────────────────────────────────────────  │
│                                             │
│  上文（可选）：让AI理解语境...  [引入上文]  │ ← 引用上文开关
│                                             │
│  ┌─────────────────────────────────────┐   │
│  │ 你怎么评价北京这个城市？             │   │
│  └─────────────────────────────────────┘   │
│                                             │
│           [ 🎵 合成试听 ]                  │
│                                             │
└─────────────────────────────────────────────┘
```

### 4.2 模式选择面板

```
┌─────────────────────────────────────────────┐
│   ════════════════════════════════════     │
│   │  🎭 默认                              │ ← 当前选中
│   │  句子前添加细节描述增强效果          │
│   │  仅部分推荐音色和复刻音色可用        │
│   │                                        │
│   │  🎤 语音指令                          │
│   │  控制情绪/方言/语气/语速等           │
│   │  让语音更具表现力                    │
│   │                                        │
│   │  📜 引用上文                         │
│   │  输入上文让模型理解语境              │
│   │  使语音更连贯自然                    │
└─────────────────────────────────────────────┘
```

### 4.3 标签选择面板（默认模式）

```
┌─────────────────────────────────────────────┐
│  ╳ 标签选择              [帮助]             │
├─────────────────────────────────────────────┤
│  情感                                               │
│  ┌────┐ ┌────┐ ┌────┐ ┌────┐ ┌────┐          │
│  │开心│ │悲伤│ │生气│ │惊讶│ │暧昧│          │
│  └────┘ └────┘ └────┘ └────┘ └────┘          │
│                                                │
│  语气                                               │
│  ┌──────┐ ┌──────┐ ┌──────┐ ┌──────┐        │
│  │撒娇  │ │严肃  │ │温柔  │ │俏皮  │        │
│  └──────┘ └──────┘ └──────┘ └──────┘        │
│                                                │
│  方言                                               │
│  ┌────┐ ┌────┐ ┌────┐ ┌────┐                  │
│  │北京话││四川话││东北话││粤语│                  │
│  └────┘ └────┘ └────┘ └────┘                  │
│                                                │
│  [自定义输入...]                    │
└─────────────────────────────────────────────┘
```

### 4.4 语音指令示例提示

```
┌─────────────────────────────────────────────┐
│  💡 示例指令                                  │
│  ─────────────────────────────────────      │
│  情绪: #开心 / #悲伤 / #生气 / #惊讶         │
│  语气: #撒娇 / #暧昧 / #吵架 / #严肃         │
│  方言: #四川话 / #北京话 / #东北话            │
│  语速: #语速慢 / #语速快 / #语速正常         │
└─────────────────────────────────────────────┘
```

## 五、支持的音色

### 5.1 语音指令/标签适用音色

| 音色ID | 名称 | 支持功能 |
|--------|------|----------|
| zh_female_cancan_mars_bigtts | 灿灿(可爱女生) | 全部 |
| zh_female_xiaoyuan_mars_bigtts | 调皮公主 | 全部 |
| zh_male_shengyang_mars_bigtts | 爽朗少年 | 全部 |
| zh_male_tiancai_mars_bigtts | 天才同桌 | 全部 |
| 复刻音色2.0 | 用户复刻 | 全部 |

### 5.2 普通音色(仅支持基础功能)

| 音色ID | 名称 |
|--------|------|
| zh_female_baiqiu_mars_bigtts | 百秋 |
| zh_male_jingying_mars_bigtts | 精英 |
| zh_female_yujie_mars_bigtts | 御姐 |

## 六、数据结构设计

### 6.1 前端状态

```typescript
interface TtsV2State {
  // 说话人
  speakers: Speaker[]
  currentSpeaker: Speaker

  // 模式
  mode: 'default' | 'voice_command' | 'context'

  // 文本
  text: string
  contextText: string  // 上文

  // 状态
  isPlaying: boolean
  isGenerating: boolean
  audioUrl: string
  subtitles: Subtitle[]
}
```

### 6.2 后端请求DTO

```java
@Data
public class TtsV2Request {
    private String text;           // 合成文本(含#指令和【标签】)
    private String contextText;    // 上文(可选)
    private String voiceType;     // 音色ID
    private String mode;          // default/voice_command/context
    private String userKey;       // 用户标识
}
```

## 七、异常处理

| 错误码 | 说明 | 处理 |
|--------|------|------|
| 45000001 | 参数错误 | 提示用户检查输入 |
| 55000001 | Session错误 | 自动重连 |
| 55000000 | 服务端错误 | 提示稍后重试 |
| WebSocket断开 | 连接中断 | 自动重连+状态恢复 |

## 八、实现计划

### Phase基础功能
1 1: . WebSocket连接管理服务
2. 双向流式TTS服务
3. 基础文本合成

### Phase 2: 核心功能
1. 语音指令解析(#指令)
2. 引用上文功能
3. 语音标签解析(【】标签)

### Phase 3: 界面优化
1. 模式选择面板
2. 标签选择组件
3. 示例指令提示

### Phase 4: 体验优化
1. 流式字幕显示
2. 播放进度同步
3. 音频缓存
