# ViVi 2.0 账户体系与会员权限 - 设计文档

## 一、核心设计目标

1. 手机号 + 密码注册/登录体系
2. 短信验证码 + 数学验证码防刷
3. 三级用户权限体系（游客 / 注册用户 / VIP）
4. 支付接口预留（Mock）

## 二、用户体系架构

### 2.1 用户角色

| 角色 | 说明 | 权限 |
|------|------|------|
| 游客 | 未登录用户 | 仅 v1.0 短文本，无情绪 |
| 注册用户 | 手机号注册 | v1.0 长文本 + v2.0 基础情绪，每月 5000 字 |
| VIP 会员 | 付费用户 | 全部功能，情绪标签，WebSocket 流式，AI 播客，边听边问 |

### 2.2 数据模型

sys_user 表新增字段：
- phone (varchar) - 手机号（唯一索引）
- password_hash (varchar) - 密码哈希
- user_type (enum) - USER, VIP
- vip_expire_date (datetime) - VIP 过期时间
- monthly_char_limit (int) - 当月字数限额
- monthly_char_used (int) - 当月已用字数
- last_char_reset_date (date) - 上次字数重置日期

## 三、注册/登录流程

### 3.1 注册流程

1. 用户输入手机号
2. 进行数学验证码校验（防机器注册）
3. 点击"获取验证码"，发送短信（60s 倒计时）
4. 输入 6 位短信验证码
5. 设置密码（至少 6 位）
6. 提交注册
7. 验证通过后创建用户，返回登录态

### 3.2 登录流程

Tab 1 - 密码登录：
1. 输入手机号 + 密码
2. 验证密码哈希
3. 返回登录态

Tab 2 - 验证码登录：
1. 输入手机号
2. 获取短信验证码
3. 输入验证码
4. 验证通过，返回登录态（自动注册新用户）

## 四、防刷机制设计

### 4.1 短信验证码

| 限制项 | 规则 |
|--------|------|
| 同一手机号 | 1 分钟 1 次，1 天 5 次 |
| 同一 IP | 1 天 20 次 |

Redis Key 设计：
- sms:code:{phone} - 验证码（5 分钟 TTL）
- sms:limit:phone:{phone} - 发送次数计数（1 天 TTL）
- sms:limit:ip:{ip} - IP 发送次数计数（1 天 TTL）

### 4.2 数学验证码

- 简单的加减法（如 "3 + 5 = ?"）
- 每次生成不同的题目
- Session 存储答案，5 分钟有效期

## 五、权限控制设计

### 5.1 字数限额

- 每月 1 日重置所有用户的字数限额
- 注册用户：5000 字/月
- VIP：无限制
- 游客：仅体验用（可选限制）

### 5.2 功能权限拦截

权限检查注解 + 拦截器实现

### 5.3 拦截器链

请求 → Token 解析 → 获取用户信息 → 权限检查 → 业务处理

## 六、支付接口设计（Mock）

### 6.1 VIP 套餐

- 月度会员：30 天 / ¥30
- 年度会员：365 天 / ¥300
- 终身会员：10 年 / ¥1000

### 6.2 订单接口

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | /api/payment/create | 创建订单 |
| GET | /api/payment/status | 查询订单状态 |
| POST | /api/payment/callback | 支付回调 |

## 七、API 设计

### 7.1 认证接口

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | /api/auth/send-code | 发送短信验证码 |
| POST | /api/auth/register | 注册 |
| POST | /api/auth/login | 密码登录 |
| POST | /api/auth/login-by-code | 验证码登录 |
| POST | /api/auth/logout | 登出 |
| GET | /api/auth/info | 获取当前用户信息 |

### 7.2 支付接口

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /api/vip/plans | 获取 VIP 套餐列表 |
| POST | /api/payment/create | 创建支付订单 |
| GET | /api/payment/status | 查询订单状态 |

## 八、数据库变更

新建表：
- sms_code - 短信验证码记录
- vip_order - VIP 订单表

sys_user 表新增字段：
- phone - 手机号
- password_hash - 密码哈希
- user_type - 用户类型
- vip_expire_date - VIP 过期时间
- monthly_char_limit - 月字数限额
- monthly_char_used - 月已用字数
- last_char_reset_date - 上次字数重置日期

## 九、错误处理

| 错误码 | 说明 |
|--------|------|
| 1001 | 手机号格式错误 |
| 1002 | 验证码错误/过期 |
| 1003 | 密码格式错误 |
| 1004 | 手机号已注册 |
| 1005 | 账号或密码错误 |
| 1006 | 短信发送过于频繁 |
| 1007 | 字数限额已用完 |
| 1008 | VIP 权限不足 |

---

设计版本: v1.0
创建日期: 2026-02-22
